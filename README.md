# gocommon

## 简介

`gocommon` 是一套面向 Go 后端项目的通用基础库。涵盖数据库、缓存、日志、配置、API 响应、工具函数、中间件、告警、调试、服务发现等常用能力，助力快速构建高质量、可扩展的微服务应用。

## 目录结构

```
├── alarm/           # 告警模块（如 Bark 推送）
├── common/          # 通用基础类型与错误处理
├── config/          # 配置加载与管理
├── constant/        # 常量定义
├── cron/            # 定时任务管理
├── db/              # 数据库与存储
│   ├── mysql/
│   ├── mongodb/
│   ├── redis/
│   ├── elasticsearch/
│   └── localcache/  # 本地缓存模块
├── debug/           # 调试与动态开关
├── http/            # HTTP 客户端封装
├── logger/          # 日志组件
├── middleware/      # Gin/HTTP 通用中间件
├── nacos/           # Nacos 配置管理与服务发现
├── prometheus/      # prometheus 监控
├── response/        # API 响应结构与绑定
├── safego/          # goroutine 安全工具
├── utils/           # 常用工具函数（加解密、IP、时间、随机数等）
└── .vscode/         # VS Code 开发配置
```

## 主要功能模块

### 数据库与存储（db/）

-   **MySQL**：[连接池、健康检查、事务、模型等](./db/mysql/README.md)
    -   支持 BaseModel 基础模型，包含 ID、CreatedAt、ModifiedAt 字段
    -   自定义 DateTime 类型，支持 JSON 序列化
-   **MongoDB**：[连接池、健康检查、事务等](./db/mongodb/README.md)
-   **Redis**：[连接池、健康检查、Hook 等](./db/redis/README.md)
-   **Elasticsearch**：[索引/文档管理、健康检查等](./db/elasticsearch/README.md)
-   **localcache**：[高性能本地缓存，基于 BigCache](./db/localcache/README.md)
    -   零 GC 压力，适合高并发、大容量缓存场景
    -   支持 TTL、类型安全缓存、缓存管理等功能
    -   提供 Cache、TypedCache、Manager 三种接口
    -   包含完整的技术选型对比文档

### 服务发现与配置管理（nacos/）

-   **Nacos 模块**：[配置管理和服务发现功能](./nacos/README.md)
-   支持多实例配置管理
-   配置的发布、获取、删除及监听
-   服务注册与发现
-   自动配置加载和初始化

### 日志（logger/）

基于 zap 的高性能日志系统，提供完整的日志解决方案：

- **多级别日志**：支持 Debug、Info、Warn、Error、Panic、Fatal 等日志级别
- **结构化日志**：支持结构化字段记录，便于日志分析和查询
- **上下文传递**：自动传递 trace_id、请求路径等上下文信息
- **日志轮转**：基于 lumberjack 的日志轮转，支持按大小和时间轮转
- **报警集成**：支持日志报警，异常情况自动发送告警
- **性能优化**：零分配日志记录，高性能输出
- **系统信息**：自动记录主机名、IP 等系统信息

### 定时任务（cron/）

提供完整的定时任务管理功能，支持任务注册、调度执行、手动触发等特性：

- **灵活调度**：支持标准 cron 表达式，精确控制任务执行时间
- **安全执行**：集成 safego 保护，防止 panic 导致服务崩溃
- **超时控制**：支持任务超时设置，自动处理超时任务
- **钩子机制**：提供 BeforeRun 和 AfterRun 钩子，支持任务前置和后置处理
- **手动触发**：支持手动执行指定任务，便于测试和运维
- **完整日志**：详细的执行日志，包含链路追踪和性能统计
- **任务隔离**：单个任务异常不影响其他任务执行

详细文档：[定时任务模块](./cron/README.md)

### 配置（config/）

提供灵活的配置管理解决方案，支持多种配置格式和动态更新：

- **多格式支持**：支持 TOML/JSON/YAML 格式配置文件，自动映射结构体
- **模块化配置**：支持模块配置注册和自动加载
    -   http/
    -   alarm/
    -   debug/
- **热重载**：支持配置热更新，无需重启服务
- **配置验证**：内置配置验证机制，确保配置正确性
- **回调机制**：支持配置加载后的初始化回调函数
- **优先级管理**：支持配置优先级，确保关键模块优先初始化
- **示例配置**：提供完整的配置文件示例：`config.toml.example` 和 `config.json.example`

### API 响应（response/）

提供标准化的 API 响应处理，确保接口返回格式统一：

- **标准响应结构**：统一的 API 响应格式，包含 code、message、data、trace_id
- **错误码管理**：预定义系统错误码，支持自定义业务错误码
- **错误处理**：完善的错误处理机制，支持错误包装和传递
- **参数绑定**：支持请求参数自动绑定和验证
- **响应拦截**：支持响应结果拦截，便于日志记录和监控
- **类型安全**：强类型响应结构，避免运行时错误

### 工具函数（utils/）

提供丰富的常用工具函数，涵盖加密解密、IP处理、时间操作、随机数生成、数据脱敏、类型判断等功能：

#### 加密解密（encryption.go）
- **AES-CBC 加密解密**：支持 AES-CBC 模式的加密解密，包含安全包装函数防止 panic
- **MD5 哈希**：`Md5X()` 计算字符串的 MD5 值
- **HMAC-SHA1**：`HMACSHA1()` 生成 HMAC-SHA1 签名

#### IP 地址处理（ip.go）
- **IP 白名单检查**：`IsBan()` 支持具体 IP 和 CIDR 格式的白名单验证
- **本地 IP 获取**：`GetLocalIP()` 获取本地优先级最高的非回环 IP 地址，支持 IPv4/IPv6
- **私有 IP 判断**：`IsPrivateIP()` 判断是否为私有 IP 地址

#### 时间处理（time.go）
- **日期格式验证**：`IsDate()` 检查日期格式是否正确
- **时间获取**：`Today()` 获取当前日期，`Now()` 获取当前日期时间，`NowTimeStamp()` 获取当前时间戳
- **时间转换**：`TimestampToDate()` 时间戳转日期，`DatetimeToTime()` 字符串转时间对象
- **时间计算**：`TimeDifference()` 计算两个时间的时间差，`GetDayTimeRange()` 获取一天的开始和结束时间

#### 随机数生成（rand.go）
- **随机数生成**：`RandomNum()` 生成指定范围的随机整数
- **随机元素**：`RandomElement()` 从 map 中随机选择元素
- **随机字符串**：`RandomString()` 生成指定长度的随机字符串（字母数字组合）
- **随机验证码**：`RandomCode()` 生成指定长度的随机数字验证码

#### 类型判断与验证（type.go）
- **字符串验证**：`IsOnlyChinese()` 判断是否只包含中文，`IsOnlyNumber()` 判断是否只包含数字
- **零值判断**：`IsZeroValue()` 判断变量是否为零值
- **格式验证**：`IsChinesePhoneNumber()` 中国手机号验证，`IsEmail()` 邮箱格式验证
- **字符串处理**：`EncodeFileName()` 文件名编码，`CleanInput()` 清理输入字符串，`CleanNewline()` 清理换行符

#### 数据脱敏（tools.go）
- **手机号脱敏**：`MaskPhoneNumber()` 智能手机号码脱敏，保留前3位和后4位，中间用*代替

#### 系统操作（os.go）
- **目录操作**：`EnsureDir()` 确保目录存在，不存在则创建

### 中间件（middleware/）

提供丰富的 Gin 中间件，涵盖认证授权、限流控制、日志记录、异常处理、链路追踪等功能：

#### 认证授权（auth.go, jwt.go）
- **JWT 认证**：`JwtAuth()` 完整的 JWT 认证中间件，支持 token 刷新、黑名单管理、自定义错误处理
- **登录态检查**：`CheckLogin()` 和 `NeedLogin()` 提供灵活的登录态检查框架，支持自定义检查逻辑
- **Token 管理**：`CreateJwtToken()` 创建 JWT token，`RevokeToken()` 撤销 token

#### 限流控制（rate_limiter.go）
- **全局限流**：支持全局限流器，所有请求共享限流配额
- **IP 限流**：为每个 IP 创建独立的限流器，支持 IP 白名单
- **智能清理**：自动清理长时间未使用的 IP 限流器，防止内存泄漏
- **灵活配置**：支持自定义限流速率、突发请求数、清理间隔等参数

#### 日志记录（iolog.go）
- **请求响应日志**：记录请求体、响应体、请求头、查询参数等详细信息
- **敏感数据脱敏**：支持正则表达式配置敏感字段，自动脱敏处理
- **大小限制**：可配置请求体和响应体的记录大小限制
- **客户端信息**：记录客户端 IP、User-Agent 等信息

#### 异常处理（recovery.go）
- **Panic 恢复**：自动捕获和恢复 panic，防止服务崩溃
- **错误日志**：记录详细的 panic 堆栈信息
- **调试模式**：在调试模式下输出 panic 信息到控制台
- **优雅降级**：返回系统错误响应，保证服务可用性

#### 链路追踪（trace.go）
- **Trace ID 生成**：自动生成或从请求头获取 trace_id
- **上下文传递**：将 trace_id 和请求路径传递到 context 中
- **服务标识**：在响应头中添加服务器主机名标识

#### 跨域处理（cors.go）
- **CORS 配置**：支持自定义允许的源、方法、请求头
- **动态源验证**：支持动态验证请求源是否在允许列表中
- **凭证支持**：支持跨域请求携带凭证信息

#### 监控指标（prometheus.go）
- **请求统计**：记录请求总数、响应状态码等指标
- **性能监控**：记录请求处理时长，支持 Prometheus 格式导出
- **路由识别**：智能识别注册的路由，避免动态路径产生过多指标

### 告警（alarm/）

提供统一的告警接口，支持多渠道告警通知：

- **统一接口**：`SendAlarm()` 统一告警接口，支持同时发送到多个渠道
- **Bark 推送**：支持 iOS Bark 推送，实时接收告警消息
- **飞书机器人**：支持飞书群机器人告警，团队协作友好
- **并发发送**：支持并发发送到多个渠道，提高告警可靠性
- **错误处理**：完善的错误处理机制，单个渠道失败不影响其他渠道
- **配置灵活**：支持动态配置告警渠道和参数

### goroutine 安全（safego/）

提供安全的 goroutine 管理工具，防止 panic 导致服务崩溃：

- **SafeGo**：安全的 goroutine 执行函数，自动捕获和恢复 panic
- **WaitGroup 封装**：`WaitGroupWrapper` 提供安全的 goroutine 等待机制
- **错误日志**：自动记录 panic 堆栈信息，便于问题排查
- **上下文传递**：支持 context 传递，便于链路追踪和超时控制
- **资源管理**：确保 goroutine 资源正确释放，防止内存泄漏

### 调试（debug/）

提供灵活的调试功能，支持动态调试开关和日志输出：

- **动态开关**：支持运行时动态开启/关闭调试功能
- **模块化调试**：支持按模块开启调试，精确控制调试范围
- **多种输出**：支持日志输出和控制台输出两种模式
- **性能友好**：调试关闭时零性能开销
- **上下文支持**：支持 context 传递，便于链路追踪

### 常量（constant/）

- 项目通用常量定义，包含上下文键、错误码等

### HTTP 客户端（http/）

基于 resty 的高性能 HTTP 客户端，提供完整的 HTTP 请求解决方案：

- **请求配置**：支持超时、重试、请求头等配置
- **重试机制**：支持自定义重试次数、重试间隔、重试条件
- **日志记录**：支持请求响应日志记录，便于调试和监控
- **透传参数**：支持上下文参数自动透传到请求头
- **响应处理**：支持响应拦截和处理
- **Cookie 管理**：支持 Cookie 自动管理和传递

### 通用类型与错误（common/）

提供通用的类型定义和错误处理机制：

- **自定义错误**：`CustomError` 支持错误码和错误信息
- **错误包装**：支持错误包装和传递，保持错误上下文
- **错误码管理**：支持业务错误码和系统错误码分离
- **环境判断**：支持开发、测试、生产环境判断
- **上下文管理**：提供统一的上下文管理机制

### 监控指标（prometheus/）

提供 Prometheus 监控指标收集和导出功能：

- **HTTP 请求统计**：`RequestsTotal` 记录 HTTP 请求总数，按方法、路径、状态码分类
- **请求时长监控**：`RequestDuration` 记录请求处理时长分布，支持直方图统计
- **自动注册**：指标自动注册到 Prometheus 默认注册表
- **中间件集成**：与 middleware 中的 Prometheus 中间件无缝集成
- **标准格式**：遵循 Prometheus 指标命名和标签规范
