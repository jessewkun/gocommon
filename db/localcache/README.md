# BigCache æœ¬åœ°ç¼“å­˜æ¨¡å—

è¿™æ˜¯ä¸€ä¸ªåŸºäº [BigCache](https://github.com/allegro/bigcache) çš„é«˜æ€§èƒ½æœ¬åœ°ç¼“å­˜æ¨¡å—ï¼Œæä¾›äº†ç»Ÿä¸€çš„ç¼“å­˜æ¥å£ã€TTL æ”¯æŒã€ç±»å‹å®‰å…¨ç¼“å­˜å’Œç¼“å­˜ç®¡ç†ç­‰åŠŸèƒ½ã€‚

## ç‰¹æ€§

-   **é«˜æ€§èƒ½**: åŸºäº BigCacheï¼Œé›¶ GC å‹åŠ›ï¼Œé€‚åˆå¤§å®¹é‡ç¼“å­˜
-   **TTL æ”¯æŒ**: æ”¯æŒè®¾ç½®ç¼“å­˜é¡¹çš„è¿‡æœŸæ—¶é—´ï¼ˆè¯¦æƒ…è§ä¸‹æ–¹**é‡è¦æ³¨æ„äº‹é¡¹**ï¼‰ã€‚
-   **ç±»å‹å®‰å…¨**: æä¾›æ³›å‹æ”¯æŒçš„ç±»å‹å®‰å…¨ç¼“å­˜ã€‚
-   **å¹¶å‘å®‰å…¨**: `Get`/`Set` ç­‰æ“ä½œæ˜¯å¹¶å‘å®‰å…¨çš„ã€‚
-   **ç»Ÿè®¡ä¿¡æ¯**: æä¾›å‘½ä¸­ã€æœªå‘½ä¸­ã€è¿‡æœŸç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚
-   **ç¼“å­˜ç®¡ç†**: æ”¯æŒå¤šä¸ªå‘½åç¼“å­˜çš„ç®¡ç†ã€‚
-   **JSON åºåˆ—åŒ–**: æ”¯æŒå¤æ‚æ•°æ®ç»“æ„çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

## é‡è¦æ³¨æ„äº‹é¡¹ (Important Caveats)

åœ¨ä½¿ç”¨æœ¬æ¨¡å—å‰ï¼Œè¯·åŠ¡å¿…ç†è§£ä»¥ä¸‹å‡ ç‚¹ï¼Œå®ƒä»¬æºäºåº•å±‚ `BigCache` çš„è®¾è®¡é™åˆ¶ï¼š

1.  **TTL è¿‡æœŸé¡¹ä¸ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜**:
    -   å½“ä¸€ä¸ªç¼“å­˜é¡¹çš„ TTL è¿‡æœŸåï¼Œ`Get` æ“ä½œä¼šæ— æ³•è·å–åˆ°å®ƒï¼Œä½†è¯¥é¡¹å ç”¨çš„**å†…å­˜ä¸ä¼šè¢«ç«‹å³é‡Šæ”¾**ã€‚
    -   å†…å­˜çš„å›æ”¶ä¾èµ–äº `BigCache` è‡ªèº«çš„æ·˜æ±°æœºåˆ¶ï¼ˆè¿‘ä¼¼ LRUï¼‰ã€‚ä¸€ä¸ªè¿‡æœŸåå†ä¹Ÿä¸è¢«è®¿é—®çš„â€œåƒµå°¸â€æ•°æ®ä¼šä¸€ç›´ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°è¢«æ–°æ•°æ®æŒ¤å‡ºã€‚
    -   **ç»“è®º**: è¯·ä¸è¦ä¾èµ– TTL ä½œä¸ºç²¾ç¡®çš„å†…å­˜ç®¡ç†å·¥å…·ã€‚

2.  **`ResetStats()` ä¸ä¼šæ¸…ç©ºæ•°æ®**:
    -   `ResetStats()` æ–¹æ³•ï¼ˆåŸ `Clear()`ï¼‰**åªä¼šé‡ç½®ç¼“å­˜çš„ç»Ÿè®¡ä¿¡æ¯**ï¼ˆå¦‚å‘½ä¸­ç‡ï¼‰ï¼Œ**ä¸ä¼šåˆ é™¤ç¼“å­˜ä¸­çš„ä»»ä½•æ•°æ®**ã€‚
    -   `BigCache` ä¸æ”¯æŒæ¸…ç©ºæ“ä½œï¼Œå› æ­¤æœ¬åº“ä¹Ÿæ— æ³•æä¾›æ­¤åŠŸèƒ½ã€‚

3.  **æ— æ³•å­˜å‚¨ `nil` ä½œä¸ºæœ‰æ•ˆçš„ç¼“å­˜å€¼**:
    -   æœ¬åº“ä½¿ç”¨ `nil` ä½œä¸ºå†…éƒ¨æ ‡è®°æ¥è¡¨ç¤ºä¸€ä¸ªç¼“å­˜é¡¹å·²è¢«â€œåˆ é™¤â€ã€‚
    -   å› æ­¤ï¼Œå¦‚æœæ‚¨å°è¯•ä½¿ç”¨ `Set` æ–¹æ³•å­˜å‚¨ä¸€ä¸ª `nil` å€¼ï¼Œä¾‹å¦‚ `cache.Set("key", nil)`ï¼Œå½“æ‚¨å†æ¬¡ `Get("key")` æ—¶ï¼Œå°†ä¼šå¾—åˆ° `(nil, false)`ï¼Œè¡¨ç¤ºè¯¥é”®ä¸å­˜åœ¨ã€‚
    -   **ç»“è®º**: è¯·é¿å…ç›´æ¥å­˜å‚¨ `nil` å€¼ï¼Œå¦åˆ™å®ƒå°†è¢«è§£é‡Šä¸ºå·²åˆ é™¤çš„é¡¹ã€‚

4.  **åºåˆ—åŒ–å¼€é”€**:
    -   ä¸ºäº†æ”¯æŒ `interface{}` å’Œæ³›å‹ç»“æ„ä½“ï¼Œæœ¬åº“ä½¿ç”¨ `json` è¿›è¡Œåºåˆ—åŒ–ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šäº§ç”Ÿé¢å¤–çš„è®¡ç®—å¼€é”€å’Œ GC å‹åŠ›ï¼Œä¸ `BigCache` çš„â€œé›¶ GCâ€ç›®æ ‡æœ‰ä¸€å®šå†²çªã€‚
    -   å¯¹äºæ€§èƒ½æå…¶æ•æ„Ÿçš„åœºæ™¯ï¼Œå»ºè®®åªç¼“å­˜åŸºç¡€ç±»å‹ï¼ˆ`string`, `[]byte`ï¼‰æˆ–è‡ªè¡Œå¤„ç†åºåˆ—åŒ–ã€‚

---

## ä¸‰ç§ç¼“å­˜æ¥å£çš„åŒºåˆ«

### 1. Cache æ¥å£ï¼ˆåŸºç¡€æ¥å£ï¼‰

```go
type Cache interface {
    Get(key string) (interface{}, bool)
    Set(key string, value interface{}) error
    SetWithTTL(key string, value interface{}, ttl time.Duration) error
    Delete(key string) bool
    ResetStats() // åªé‡ç½®ç»Ÿè®¡ï¼Œä¸æ¸…é™¤æ•°æ®
    Size() int
    Capacity() int
    Stats() Stats
    Close() error
}
```

### 2. TypedCache æ¥å£ï¼ˆç±»å‹å®‰å…¨æ¥å£ï¼‰

```go
type TypedCache[T any] interface {
    Get(key string) (T, bool)
    Set(key string, value T) error
    SetWithTTL(key string, value T, ttl time.Duration) error
    Delete(key string) bool
    ResetStats() // åªé‡ç½®ç»Ÿè®¡ï¼Œä¸æ¸…é™¤æ•°æ®
    Size() int
    Capacity() int
    Stats() Stats
    Close() error
}
```
**ç‰¹ç‚¹**:
-   ä¸ `Cache` æ¥å£åŠŸèƒ½å¯¹ç­‰ï¼Œä½†æä¾›ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ã€‚
-   é¿å…äº†è¿è¡Œæ—¶ç±»å‹æ–­è¨€çš„éœ€è¦å’Œé£é™©ã€‚

**ä½¿ç”¨ç¤ºä¾‹**:
```go
type User struct {
    ID   int    `json:"id"`
    Name string `json:"name"`
}

userCache, _ := NewTypedBigCache[User](1000)
user := User{ID: 1, Name: "å¼ ä¸‰"}
userCache.Set("user:1", user)

if cachedUser, exists := userCache.Get("user:1"); exists {
    fmt.Println(cachedUser.Name) // cachedUser æ˜¯ User ç±»å‹
}
```

### 3. Manager ç®¡ç†å™¨ï¼ˆå¤šç¼“å­˜ç®¡ç†ï¼‰

**ç‰¹ç‚¹**:
-   åœ¨ä¸€ä¸ªç»Ÿä¸€çš„å¯¹è±¡ä¸­ç®¡ç†å¤šä¸ªå‘½åçš„ `Cache` å®ä¾‹ã€‚
-   æ¯ä¸ªç¼“å­˜æ‹¥æœ‰ç‹¬ç«‹çš„é…ç½®å’Œç”Ÿå‘½å‘¨æœŸã€‚

**ä½¿ç”¨ç¤ºä¾‹**:
```go
manager := NewManager()
defer manager.ClearAll() // ç¡®ä¿æ‰€æœ‰ç¼“å­˜è¢«å…³é—­

// è·å–é€šç”¨ç¼“å­˜
userCache, _ := manager.GetCache("users", 1000)
userCache.Set("user:1", "ç”¨æˆ·æ•°æ®")

// è·å–ç±»å‹å®‰å…¨çš„ç¼“å­˜ (æ¨èæ–¹å¼)
type Product struct{ ID int, Name string }
productCache, _ := localcache.GetTypedCache[Product](manager, "products", 500)
productCache.Set("p:1", Product{ID: 1, Name: "ç”µè„‘"})
```

### æ¥å£å¯¹æ¯”è¡¨

| ç‰¹æ€§           | Cache               | TypedCache        | Manager & GetTypedCache      |
| -------------- | ------------------- | ----------------- | ---------------------------- |
| **ç±»å‹å®‰å…¨**   | âŒ ä½¿ç”¨ interface{} | âœ… ç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ | âœ… æä¾›æ³›å‹å‡½æ•°è·å–ç±»å‹å®‰å…¨ç¼“å­˜ |
| **ç±»å‹æ–­è¨€**   | éœ€è¦                | ä¸éœ€è¦            | ä¸éœ€è¦                       |
| **æ³›å‹æ”¯æŒ**   | âŒ                  | âœ…                | âœ… (é€šè¿‡è¾…åŠ©å‡½æ•°)            |
| **å¤šç¼“å­˜ç®¡ç†** | âŒ                  | âŒ                | âœ…                           |
| **ä½¿ç”¨åœºæ™¯**   | ç®€å•ã€åŠ¨æ€ç±»å‹      | ç±»å‹å¼ºç›¸å…³çš„ä¸šåŠ¡  | éœ€è¦ç®¡ç†å¤šä¸ªä¸åŒç¼“å­˜çš„åœºæ™¯   |

### é€‰æ‹©å»ºè®®

1.  **ç±»å‹å®‰å…¨åœºæ™¯ (æ¨è)**: ä¼˜å…ˆä½¿ç”¨ `NewTypedBigCache` æˆ– `GetTypedCache`ã€‚
    ```go
    // å•ä¸€ç¼“å­˜
    userCache, _ := NewTypedBigCache[User](1000)

    // ä»ç®¡ç†å™¨è·å–
    manager := NewManager()
    productCache, _ := GetTypedCache[Product](manager, "products", 500)
    ```

2.  **å¤šç¼“å­˜ç®¡ç†**: ä½¿ç”¨ `Manager`ï¼Œå¹¶ç»“åˆ `GetCache` å’Œ `GetTypedCache`ã€‚
    ```go
    manager := NewManager()
    // è·å–éç±»å‹å®‰å…¨ç¼“å­˜
    sessions, _ := manager.GetCache("sessions", 1000)
    // è·å–ç±»å‹å®‰å…¨ç¼“å­˜
    users, _ := GetTypedCache[User](manager, "users", 2000)
    ```

## API å‚è€ƒ

(è¯·å‚è€ƒä»£ç ä¸­çš„æ¥å£å®šä¹‰)

### Stats ç»“æ„ä½“

```go
type Stats struct {
    Hits        int64 `json:"hits"`        // å‘½ä¸­æ¬¡æ•°
    Misses      int64 `json:"misses"`      // æœªå‘½ä¸­æ¬¡æ•°
    Evictions   int64 `json:"evictions"`   // æ·˜æ±°æ¬¡æ•° (å½“å‰ç‰ˆæœ¬æ— æ³•ç»Ÿè®¡ï¼Œæ’ä¸º0)
    Expirations int64 `json:"expirations"` // è¿‡æœŸæ¬¡æ•° (è®¿é—®è¿‡æœŸkeyæ—¶è®¡æ•°)
}
```

## æµ‹è¯•

è¿è¡Œå•å…ƒæµ‹è¯•ï¼š
```bash
go test ./db/localcache -v
```

è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼š
```bash
go test ./db/localcache -bench=.
```

## ä¾èµ–

-   `github.com/allegro/bigcache` - é«˜æ€§èƒ½ç¼“å­˜åº“
-   `github.com/jessewkun/gocommon/common` - é€šç”¨é”™è¯¯å¤„ç†

## æŠ€æœ¯é€‰å‹

å¦‚æœæ‚¨æ­£åœ¨è€ƒè™‘é€‰æ‹©ä¸åŒçš„ç¼“å­˜åº“ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä»¬çš„æŠ€æœ¯é€‰å‹æ–‡æ¡£ï¼š

ğŸ“– **[æŠ€æœ¯é€‰å‹å¯¹æ¯”](./TECHNOLOGY_CHOICE.md)** - è¯¦ç»†å¯¹æ¯” BigCacheã€Ristretto å’Œ FreeCache çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯

è¯¥æ–‡æ¡£åŒ…å«ï¼š

-   ä¸‰ä¸ªç¼“å­˜åº“çš„è¯¦ç»†å¯¹æ¯”è¡¨
-   é…ç½®å¤æ‚åº¦åˆ†æ
-   æ€§èƒ½å¯¹æ¯”æ•°æ®
-   é€‰æ‹©å»ºè®®å’Œè¿ç§»ç­–ç•¥
-   å‚è€ƒèµ„æ–™å’Œè®ºæ–‡é“¾æ¥
